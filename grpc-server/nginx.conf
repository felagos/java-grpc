events {
    worker_connections 1024;
}

http {
    # gRPC upstream - 3 server instances
    upstream grpc_servers {
        # IP hash for session affinity (required for bidirectional streaming)
        ip_hash;
        
        server grpc-server-1:6565;
        server grpc-server-2:6565;
        server grpc-server-3:6565;
        
        # Keep-alive connections to backend servers
        keepalive 32;
        
        # Health checks for gRPC backends
        # Requires nginx-plus or custom health check module
        # health_check interval=10s fails=3 passes=2;
    }

    # Logging
    log_format grpc_log '$remote_addr - [$time_local] "$request" '
                        '$status $body_bytes_sent "$http_referer" '
                        'upstream: $upstream_addr';
    
    access_log /var/log/nginx/grpc_access.log grpc_log;
    error_log /var/log/nginx/grpc_error.log warn;

    server {
        listen 6565;
        http2 on;
        server_name _;

        # gRPC specific settings for streaming
        grpc_read_timeout 1d;
        grpc_send_timeout 1d;
        client_body_timeout 1d;
        
        # Essential for bidirectional streaming
        grpc_socket_keepalive on;
        
        # Health check endpoint
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }

        # gRPC services
        location / {
            grpc_pass grpc://grpc_servers;
            
            # Essential for bidirectional streaming
            grpc_socket_keepalive on;
            
            # Error handling for gRPC
            error_page 502 = /error502grpc;
            
            # Headers for full duplex streaming
            grpc_set_header Host $host;
            grpc_set_header X-Real-IP $remote_addr;
            grpc_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            grpc_set_header Connection "";
        }

        location = /error502grpc {
            internal;
            default_type application/grpc;
            add_header grpc-status 14;
            add_header grpc-message "Unavailable";
            return 204;
        }
    }
}
